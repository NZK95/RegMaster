### PCI (PCI Express) — это шина для подключения периферийных устройств, где каждое устройство находится в конфигурационном пространстве и имеет уникальный адрес в формате **Bus:Device:Function (BDF)**.

---

**PCI конфигурационное пространство** — это область памяти размером **256 байт** (или **4096 байт** для **PCIe**), которая содержит информацию о подключенном устройстве. Эта информация включает различные параметры, такие как **VendorID**, **DeviceID**, **BAR регистры** и другие. Эти параметры находятся на **фиксированных оффсетах**. <br> Примерная структура конфигурационного пространства:

<p align="left">
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhoY3zltlssAWqonkWjZ75O2G-2ktq-OZ-Qoy-OKe4aqS3P-tx0RNK9do3bfDdJsYOl1KUDQXmEiWlqQYnSZw6zmI7LbPaXU_Sdrv8n3-YHOYWuVO_EZ5hE9boOqFzk7qk8jcl1QOe1BI/s1600/pci+configuration+space.png">
</p>

> Firmware скрывает некоторые PCI устройства, и любое их чтение возвращает 0xFFFFFFFF (скрыт).

---

### BAR регистры
**BAR регистры** (Base Address Registers) — это ключевые параметры, которые содержат **физические адреса** в памяти, по которым маппируются ресурсы устройства. Нас интересуют MMIO регионы (обычно **BAR0**).
<br>Каждое устройство может содержать несколько **BAR регистров**, и для того чтобы понять, что конкретно маппируется в тот или иной BAR, нужно обращаться к спецификации устройства. <br>
Первые 4 бита (0 - 3) это флаги BAR регистра. К примеру возьмем BAR xHCI контроллера: <br> `0x53400004`  = `01010011010000000000000000000100` . <br><br>
**Бит 0:** Type (0=Memory, 1=I/O) <br>
**Биты 1-2:** Тип адреса (00=32bit, 10=64bit) <br>
**Бит 3:** Prefetchable <br> 
**Биты 4-31:** Физический адрес <br> 

---

### Пример описания BAR регистров устройства:
- **BAR0**: 0xE0200000 - 0xE0201FFF (8 KB) — **I/O Port**
- **BAR1**: 0xE0202000 - 0xE0202FFF (4 KB) — **MMIO**
- **BAR2**: 0xE0203000 - 0xE0203FFF (4 KB) — **Flash ROM**
- **BAR3**: 0xE0204000 - 0xE0204FFF (4 KB) — **MSI-X** 


## Ссылки
- [PCI Configuration Space](https://en.wikipedia.org/wiki/PCI_configuration_space)
- [PCI IDS](https://pci-ids.ucw.cz/)
